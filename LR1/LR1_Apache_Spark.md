# Лабораторная работа 1

Работа начинается с инициализации сессии и загрузки необходимых данных: 

![1](https://github.com/vmokook/BigData/blob/main/LR1/Images/1.png)

![2](https://github.com/vmokook/BigData/blob/main/LR1/Images/2.png) ![3](https://github.com/vmokook/BigData/blob/main/LR1/Images/3.png)     


## 1. Найти велосипед с максимальным временем пробега.

Для нахождения велосипеда с максимальным временем пробега для начала выполняется группировка данных
`trip.groupBy("bike_id")` о поездках по уникальным значениям в столбце "bike_id". Это позволяет получить 
информацию о всех поездках, связанных с конкретным велосипедом.
После группировки применяется функция 'max("duration")', которая позволяет вычислить максимальное значение 
столбце "duration" для каждой группы. Затем результат получает псевдоним "max_duration".
Далее используется метод orderBy для сортировки результатов в порядке убывания времени пробега.
`col("max_duration").desc()` указывает, что происходит сортировка по столбцу "max_duration" в порядке убывания.
`.first()` - выбирает первую строку в отсортированных данных. Таким образом, получается велосипед с максимальным временем пробега.
  
![4](https://github.com/vmokook/BigData/blob/main/LR1/Images/4.png)


## 2. Найти наибольшее геодезическое расстояние между станциями.

1. `station_joined` - представляет из себя новую таблицу, для ее создания было выплолнено декартово произведение 
(`cross join`) исходной таблицы station с самой собой. Это было сделано для рассмотрения всех вохможных комбинаций 
по долготе и широте. Данная таблица создается с использованием псевдонимов "st1" и "st2" для каждой копии, чтобы избежать 
конфликтов имен столбцов.

2. Задаемся радиусом Земли для вычисления геодезического расстояния по формуле Хаверсина (https://en.wikipedia.org/wiki/Haversine_formula)

3. Функция `geodesic_distance` принимает 4 параметра (lat1, lon1, lat2, lon2), представляющих собой широту и долготу для двух станций.  
Далее происходит вычисление по формуле. 

3. Создаем пользовательскую функцию (UDF) `geodesic_distance_udf`, используемую для применения функции `geodesic_distance` к столбцам.

4. Добавляем новый столбец "geodesic_distance" к station_joined. Данный столбец вычисляется с использованием geodesic_distance_udf.
Этот столбец представляет собой геодезическое расстояние между каждой парой станций.

5. `max_distance = station_joined_distance.orderBy(col("geodesic_distance").desc()).first():`
Сортируем station_joined_distance в порядке убывания геодезического расстояния и выбираем первую строку с максимальным расстоянием.

![5](https://github.com/vmokook/BigData/blob/main/LR1/Images/5.png )
![6](https://github.com/vmokook/BigData/blob/main/LR1/Images/6.png )


## 3. Найти путь велосипеда с максимальным временем пробега через станции.

1. Для начала определяем максимальное время пробека и bike_id, который его достиг.
`max_duration_info = trip.agg({"duration": "max"}).collect()[0]` - объединение по максимальному значению столбца "duration" в trip.
Результат сохраняется в переменной max_duration_info. Далее извлекается максимальное значение времени пробега. Исходя из
этих данных находим bike_id, у которого достигнуто максимальное время пробега.

2. Создаем таблицу "max_duration_trips", содержащую только поездки для велосипеда с максимальным временем пробега. Затем
выполняем объединение max_duration_trips с station по соответствующим стартовым идентификаторам станций.

3. Далее выполняем объединение таблиц "trip" и "station" по соответствующим стартовым идентификаторам станций для велосипеда с максимальным
временем пробега. Выбираеются необходимые столбцы с помощью метода `select`. Конечная таблица сортируется по убыванию продолжительности поездки.
И результат выводится в виде таблицы. Первое значение в таблице соотвествует поездкам веловсипеда с максимальным временем пробега. 

![7](https://github.com/vmokook/BigData/blob/main/LR1/Images/7.png )
![8](https://github.com/vmokook/BigData/blob/main/LR1/Images/8.png )


## 4. Найти количество велосипедов в системе.
Найти пользователей потративших на поездки более 3 часов.
